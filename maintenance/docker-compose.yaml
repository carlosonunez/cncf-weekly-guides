volumes:
  cncf-weekly-projects-list-vol: {}
  cncf-weekly-secrets-vol: {}
services:
  update_cncf_projects_lists:
    depends_on:
      confirm_config_decrypted:
        condition: service_completed_successfully
    build:
      dockerfile: include/dockerfiles/default.Dockerfile
      context: .
    volumes:
      - cncf-weekly-projects-list-vol:/data
      - $PWD/.cncf-weekly-todos:/todo
      - $PWD/config.yaml:/config.yaml
    entrypoint:
      - /scripts/build_projects.sh
  pick_cncf_weekly_project:
    depends_on:
      update_cncf_projects_lists:
        condition: service_completed_successfully
    build:
      dockerfile: include/dockerfiles/default.Dockerfile
      context: .
    volumes:
      - cncf-weekly-projects-list-vol:/data
      - $PWD/.cncf-weekly-todos:/todo
    entrypoint:
      - /scripts/pick_project.sh
  skip_picked_project:
    build:
      dockerfile: include/dockerfiles/default.Dockerfile
      context: .
    volumes:
      - cncf-weekly-projects-list-vol:/data
      - $PWD/.cncf-weekly-todos:/todo
    entrypoint:
      - /scripts/skip_wip_project.sh
  update_containerized_config:
    build:
      dockerfile: include/dockerfiles/default.Dockerfile
      context: .
    volumes:
      - cncf-weekly-secrets-vol:/secrets
    stdin_open: true
    entrypoint: ["bash"]
    command:
      - -c
      - 'cat /dev/stdin > /secrets/config.yaml'
  confirm_config_decrypted:
    build:
      dockerfile: include/dockerfiles/default.Dockerfile
      context: .
    volumes:
      - cncf-weekly-secrets-vol:/secrets
    entrypoint: sh
    command:
      - -xc
      - |-
        test -f /secrets/config.yaml &&
        test -z $(yq -r .decrypted /secrets/config.yaml | grep -q ENC)
